<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Tracker - With Duration & Report</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  .controls { margin-bottom: 10px; }
  input, select, button { margin-right: 5px; padding: 4px 8px; }
  .event { display: flex; justify-content: space-between; align-items: center;
           padding: 5px; margin: 3px 0; border-radius: 6px; }
  .event.start { background: orange; }
  .event.done { background: lightgreen; }
  .event button { margin-left: 10px; }
</style>
</head>
<body>

<div class="controls">
  <button id="importBtn">Import JSON</button>
  <button id="exportBtn">Export JSON</button>
  <button id="reportBtn">Show Daily Report</button>
  <select id="dateSelect"></select>
  <input type="text" id="taskInput" placeholder="Task name">
  <button id="startBtn">Start Task</button>
  <input type="file" id="fileInput" style="display:none">
</div>

<div id="eventList"></div>

<script>
const STORAGE_KEY = "eventData_v4";

// ---- Helpers ----
function getTodayStr() {
  const d = new Date();
  return d.toLocaleDateString('en-GB').split('/').reverse().join('-'); // yyyy-mm-dd
}
//function formatTime(d) {
 // return d.toLocaleString('en-GB'); // dd/mm/yyyy, HH:MM:SS
//}
function formatDisplay(d) {
  // nice display string for user
  return d.toLocaleString('en-GB');
}
function formatTime(d) {
  // ISO string used for calculations
  return d.toISOString();
}

function diffDuration(start, end) {
  const s = new Date(start);
  const e = new Date(end);
  const diffMs = e - s;
  const mins = Math.floor(diffMs / 60000);
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}
function loadData() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
}
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function getDates(data) {
  return Object.keys(data).sort().reverse();
}

// ---- Elements ----
const dateSelect = document.getElementById("dateSelect");
const taskInput = document.getElementById("taskInput");
const startBtn = document.getElementById("startBtn");
const eventList = document.getElementById("eventList");
const importBtn = document.getElementById("importBtn");
const exportBtn = document.getElementById("exportBtn");
const reportBtn = document.getElementById("reportBtn");
const fileInput = document.getElementById("fileInput");

let data = loadData();
let currentDate = getTodayStr();

// ---- UI & Logic ----
function populateDateSelect() {
  dateSelect.innerHTML = "";
  const dates = getDates(data);
  if (!dates.includes(currentDate)) dates.push(currentDate);
  dates.sort().reverse();
  for (const d of dates) {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    dateSelect.appendChild(opt);
  }
  dateSelect.value = currentDate;
}

function renderEvents() {
  const events = data[currentDate] || [];
  const ongoing = events.filter(e => e.status === "start");
  const done = events.filter(e => e.status === "done")
                     .sort((a,b)=> new Date(b.endTime||0) - new Date(a.endTime||0));
  const sorted = [...ongoing, ...done];

  eventList.innerHTML = "";
  for (const ev of sorted) {
    const div = document.createElement("div");
    div.className = "event " + ev.status;

    let text = `${ev.task}: ${ev.status.toUpperCase()}`;
    //if (ev.status === "start") text += ` - ${ev.startTime}`;
    //else text += ` - ${ev.startTime} → ${ev.endTime} (${ev.duration})`;
    if (ev.status === "start")
        text += ` - ${new Date(ev.startTime).toLocaleString('en-GB')}`;
    else
        text += ` - ${new Date(ev.startTime).toLocaleString('en-GB')} → ${new Date(ev.endTime).toLocaleString('en-GB')} (${ev.duration})`;
    div.innerHTML = `<span>${text}</span>`;

    const btn = document.createElement("button");
    if (ev.status === "start") {
      btn.textContent = "End";
      btn.onclick = () => endTask(ev);
    } else {
      btn.textContent = "Resume";
      btn.onclick = () => resumeTask(ev.task);
    }
    div.appendChild(btn);
    eventList.appendChild(div);
  }
}

function taskActive(name) {
  const events = data[currentDate] || [];
  return events.some(e => e.task.toLowerCase() === name.toLowerCase() && e.status === "start");
}

function startTask(name) {
  if (!name.trim()) return;
  name = name.trim().toLowerCase();
  if (taskActive(name)) return alert("Task already active today.");
  const ev = { task: name, status: "start", startTime: formatTime(new Date()) };
  if (!data[currentDate]) data[currentDate] = [];
  data[currentDate].push(ev);
  saveData(data);
  renderEvents();
}

function endTask(ev) {
  ev.status = "done";
  ev.endTime = formatTime(new Date());
  ev.duration = diffDuration(ev.startTime, ev.endTime);
  saveData(data);
  renderEvents();
}

function resumeTask(name) {
  if (taskActive(name)) return alert("Task already active today.");
  const ev = { task: name.toLowerCase(), status: "start", startTime: formatTime(new Date()) };
  if (!data[currentDate]) data[currentDate] = [];
  data[currentDate].push(ev);
  saveData(data);
  renderEvents();
}

function showDailyReport() {
  const events = data[currentDate] || [];
  const doneEvents = events.filter(e => e.status === "done");
  if (doneEvents.length === 0) return alert("No completed tasks for this day.");

  const totals = {};
  for (const ev of doneEvents) {
    const name = ev.task.toLowerCase();
    const s = new Date(ev.startTime);
    const e = new Date(ev.endTime);
    const diffMs = e - s;
    totals[name] = (totals[name] || 0) + diffMs;
  }

  let report = `Time Report for ${currentDate}\n`;
  for (const [task, ms] of Object.entries(totals)) {
    const mins = Math.floor(ms / 60000);
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    const dur = h > 0 ? `${h}h ${m}m` : `${m}m`;
    report += `${task}: ${dur}\n`;
  }
  alert(report);
}

// ---- Import / Export ----
exportBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "eventData.json";
  a.click();
};

importBtn.onclick = () => fileInput.click();

fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      data = JSON.parse(ev.target.result);
      saveData(data);
      populateDateSelect();
      renderEvents();
    } catch { alert("Invalid JSON file"); }
  };
  reader.readAsText(file);
};

// ---- Event bindings ----
startBtn.onclick = () => startTask(taskInput.value);
dateSelect.onchange = e => { currentDate = e.target.value; renderEvents(); };
reportBtn.onclick = showDailyReport;

// ---- Init ----
populateDateSelect();
renderEvents();
</script>
</body>
</html>
